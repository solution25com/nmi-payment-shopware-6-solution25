(()=>{"use strict";class e{static loadCollectJS(e,t,r){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:()=>{},n=document.getElementById("nmi-credit-card"),o=document.getElementById("nmi-ach-echeck");null==n&&(n=o);let s=JSON.parse(n.getAttribute("data-configs"));return new Promise((n,o)=>{if("undefined"==typeof CollectJS){let d=document.createElement("script");d.src=e,d.setAttribute("data-tokenization-key",s.publicKey),document.head.appendChild(d),d.onload=()=>{try{CollectJS.configure({paymentType:r,callback:t,...a}),n()}catch(e){i(),o()}},d.onerror=()=>{console.error("Failed to load CollectJS."),i(),o()}}else CollectJS.configure({paymentType:r,callback:t,...a}),n()})}}class t{static loadGatewayJS(e){return new Promise((t,r)=>{let a=document.createElement("script");a.src=e,a.async=!0,a.onload=()=>t(Gateway),a.onerror=()=>r(Error("Failed to load Gateway.js.")),document.head.appendChild(a)})}static createGateway(e){if("undefined"==typeof Gateway)throw Error("Gateway SDK is not loaded. Call loadGatewayJS first.");return Gateway.create(e)}}class r{static submitPayment(e,t){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(async e=>{if(!e.ok){let t=await e.json().catch(()=>null);throw Error(t?.message||"Payment submission failed with an unknown error")}return e.json()}).catch(e=>{throw console.error("Error during payment submission:",e),e})}static fetchCustomerData(e,t){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(async e=>{if(!e.ok){let t=await e.json().catch(()=>null);throw Error(t?.message||"Failed to fetch customer data due to an unknown error")}return e.json()}).catch(e=>{throw console.error("Error fetching customer data:",e),e})}static addBillingToCustomerData(e,t){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(async e=>{if(!e.ok){let t=await e.json().catch(()=>null);throw Error(t?.message||"Failed to add customer billing data ")}return e.json()}).catch(e=>{throw console.error("Error adding customer billing data:",e),e})}}class a extends window.PluginBaseClass{static #e=this.options={confirmFormId:"confirmOrderForm",formSelector:".lightbox-container",paymentUrls:{creditCard:"/nmi-payment-credit-card",vaulted:"/nmi-payment-vaulted-customer",getVaultedData:"/nmi-payment-get-vaulted-customer",deleteVaultedCustomerData:"/nmi-payment-delete-vaulted-customer",addCard:"/nmi-add-card"},collectJsUrl:"https://secure.nmi.com/token/Collect.js",gatewayJsUrl:"https://secure.nmi.com/js/v1/Gateway.js",paymentType:"cc",parentCreditCardWrapperId:"nmi-credit-card"};_configurationError(){let e=document.getElementById(this.options.parentCreditCardWrapperId).getAttribute("data-payment-method-id"),t=document.getElementById("paymentMethod"+e),r=t.parentElement.parentElement;t.disabled=!0;let a=document.createElement("div");a.className="payment-error",a.textContent="Configuration Error",a.style.color="red",a.style.marginTop="5px",r.appendChild(a),document.getElementsByClassName("nmiConfirmFormSubmit")[0].disabled=!0,document.getElementById("pay-with-new-card").disabled=!0}init(){e.loadCollectJS(this.options.collectJsUrl,()=>{},this.options.paymentType,{},()=>{this._configurationError()}),this._registerElements(),this._registerEvents(),this.isSavedCardBackend&&this.getVaultedCustomerData()}_registerElements(){this.parentCreditCardWrapper=document.getElementById(this.options.parentCreditCardWrapperId),this.vaultedId=this.parentCreditCardWrapper.getAttribute("data-vaulted-customer-id"),this.billingId=this.parentCreditCardWrapper.getAttribute("data-billing-customer-id"),this.isSavedCardBackend=this.parentCreditCardWrapper.getAttribute("data-saved-card"),this.currency=this.parentCreditCardWrapper.getAttribute("data-shop-currency"),this.amount=this.parentCreditCardWrapper.getAttribute("data-amount"),this.threeDSConfig=this.parentCreditCardWrapper.getAttribute("data-threeDSConfig"),this.dropdownCards=this.parentCreditCardWrapper.getAttribute("data-dropdown-cards"),this.deleteDataBtn=document.getElementById("delete-vaulted-customer-data"),this.addMoreCards=document.getElementById("add-another-vaulted-card"),this.loader=document.getElementById("nmiLoader"),this.configs=JSON.parse(this.parentCreditCardWrapper.getAttribute("data-configs")),this.billingFirstName=this.parentCreditCardWrapper.getAttribute("data-billing-first-name"),this.billingLastName=this.parentCreditCardWrapper.getAttribute("data-billing-last-name"),this.billingCity=this.parentCreditCardWrapper.getAttribute("data-billing-city"),this.confirmOrderForm=document.forms[this.options.confirmFormId],this.cards=JSON.parse(this.dropdownCards)}_registerEvents(){this.confirmOrderForm.addEventListener("submit",this._onPayButtonClick.bind(this)),this.deleteDataBtn&&this.deleteDataBtn.addEventListener("click",this._onDeleteButtonClick.bind(this)),this.addMoreCards&&this.addMoreCards.addEventListener("click",this._onAddCardButtonClick.bind(this));let e=document.getElementById("pay-with-new-card");e&&e.addEventListener("click",this._onPayWithNewCard.bind(this));let t=document.getElementById("cardSelect");t?.addEventListener("change",e=>{let t=e.target.value,r=this.cards.find(e=>e.billingId===t);r&&this.displayVaultedCustomerData({first_name:r.firstName,last_name:r.lastName,cc_number:r.lastDigits,cc_type:r.cardType})})}async _onPayButtonClick(t){t.preventDefault(),this._showLoading(!0);try{if(await e.loadCollectJS(this.options.collectJsUrl,this.submitPayment.bind(this),this.options.paymentType,{}),!this.confirmOrderForm.checkValidity())return;this.isSavedCardBackend?this.submitVaultedPayment():"undefined"!=typeof CollectJS?CollectJS.startPaymentRequest():this.displayErrors(["Payment library (CollectJS) could not be loaded."])}catch(e){this.displayErrors([e.message||"Unexpected error occurred while processing payment."])}finally{this._showLoading(!1)}}async _onPayWithNewCard(t){t.preventDefault(),this._showLoading(!0);try{await e.loadCollectJS(this.options.collectJsUrl,this.submitPaymentWithNewC.bind(this),this.options.paymentType,{theme:"bootstrap",primaryColor:"#007bff",secondaryColor:"#6c757d",buttonText:"Pay Now"}),"undefined"!=typeof CollectJS?CollectJS.startPaymentRequest():this.displayErrors(["Payment library (CollectJS) could not be loaded."])}catch(e){this.displayErrors([e.message||"Unexpected error occurred while loading payment form."])}finally{this._showLoading(!1)}}async _onDeleteButtonClick(e){e.preventDefault(),this._showLoading(!0),await this.deleteVaultedCustomerData()}async _onAddCardButtonClick(t){t.preventDefault(),this._showLoading(!0);try{if(await e.loadCollectJS(this.options.collectJsUrl,this.addBillingToCustomer.bind(this),this.options.paymentType,{theme:"bootstrap",primaryColor:"#ff288d",secondaryColor:"#3e79db",buttonText:"Add New Credit Card"}),!this.confirmOrderForm.checkValidity()){this.displayErrors(["Please complete all required fields before adding a card."]);return}"undefined"!=typeof CollectJS?CollectJS.startPaymentRequest():this.displayErrors(["Payment library (CollectJS) could not be loaded."])}catch(e){this.displayErrors([e.message||"Unexpected error occurred while adding a new card."])}finally{this._showLoading(!1)}}_showLoading(e){let t=document.getElementById("nmiLoader");t&&(t.style.display=e?"inline-block":"none")}submitPayment(e){try{if(!e||!e.token){this.displayErrors(Array.isArray(e?.error)?e.error:[e?.error||"Tokenization failed."]);return}this.isSavedCardBackend?(this.submitVaultedPayment(e),this._showLoading(!1)):this.submitNormalPayment(e)}catch(e){this.displayErrors([e.message||"Unexpected error occurred during payment submission."]),this._showLoading(!1)}}submitPaymentWithNewC(e){if(!e.token){this.displayErrors(e.error);return}this.submitNormalPayment(e)}addBillingToCustomer(e){e.token?this.addCards(e):this.displayErrors(e.error)}async addCards(e){let t={token:e.token,ccnumber:e.card.number,ccexp:e.card.exp,card_type:e.card.type,vaulted_customer_id:this.vaultedId,first_name:this.billingFirstName,last_name:this.billingLastName};await this.submitCard(this.options.paymentUrls.addCard,t)}async deleteVaultedCustomerData(){let e={customer_vault_id:this.vaultedId},t=this.options.paymentUrls.deleteVaultedCustomerData;try{await r.fetchCustomerData(t,e),window.location.reload()}catch(e){this.displayErrors(error),this._showLoading(!1)}}async getVaultedCustomerData(){let e={customer_vault_id:this.vaultedId},t=this.options.paymentUrls.getVaultedData;this._showLoading(!0);try{let a=await r.fetchCustomerData(t,e);this.fillDropdown(a),this.displayVaultedCustomerData(a)}catch(e){this.displayErrors([e.message||"Failed to fetch vaulted customer data."])}finally{this._showLoading(!1)}}fillDropdown(e){let t=document.getElementById("cardSelect");if(t.innerHTML="",this.cards.length>0)this.cards.forEach(r=>{let a=document.createElement("option");a.value=r.billingId,a.textContent=`${r.firstName} ****${r.lastDigits.slice(-4)}`,r.billingId===e.billingId&&(a.selected=!0),t.appendChild(a)});else{let e=document.createElement("option");e.value="",e.textContent="No saved cards available",t.appendChild(e)}}displayVaultedCustomerData(e){let{first_name:t,last_name:r,cc_number:a,cc_type:i}=e,n=a.slice(-4);document.getElementById("vaulted-first-name").innerText=t,document.getElementById("vaulted-last-name").innerText=r,document.getElementById("vaulted-last-four-digits").innerText="**** **** **** "+n,document.getElementById("vaulted-card-type").innerText=i}submitNormalPayment(e){let r,a;let i=document.getElementById("nmi-credit-card").getAttribute("data-flow"),n=this.threeDSConfig,o={token:e.token,amount:this.amount,first_name:document.querySelector('input[name="fname"]').value,last_name:document.querySelector('input[name="lname"]').value,address1:document.querySelector('input[name="address1"]').value,city:this.billingCity,zip:document.querySelector('input[name="zip"]').value,ccnumber:e.card.number,ccexp:e.card.exp,card_type:e.card.type,customer_vault:document.querySelector("#saveCardCheckbox")&&document.querySelector("#saveCardCheckbox").checked?"add_customer":null,saveCard:!!document.querySelector("#saveCardCheckbox")&&document.querySelector("#saveCardCheckbox").checked};if("order_payment"===i)document.getElementById("nmiPaymentData").value=JSON.stringify(o),document.getElementById("confirmOrderForm").submit();else if(n){let i=document.createElement("script");i.src=this.options.gatewayJsUrl,document.head.appendChild(i),i.onload=()=>{if(r=t.createGateway(this.configs.checkoutKey)){a=r.get3DSecure(),o.cavv=e.cavv,o.xid=e.xid,o.eci=e.eci,o.cardHolderAuth=e.cardHolderAuth,o.threeDsVersion=e.threeDsVersion,o.directoryServerId=e.directoryServerId,o.cardHolderInfo=e.cardHolderInfo;let t=a.createUI(o);t.start("body"),t.on("challenge",function(){}),t.on("failure",e=>{this.displayErrors([e.message||"3D Secure authentication failed."])}),r.on("error",e=>{this.displayErrors([e.message||"3D Secure authentication failed."])}),this.submitToPaymentService(this.options.paymentUrls.creditCard,o)}},i.onerror=()=>{this.displayErrors(["Failed to load Gateway.js."])}}else this.submitToPaymentService(this.options.paymentUrls.creditCard,o)}submitVaultedPayment(){let e=document.getElementById("nmi-credit-card").getAttribute("data-flow");this._showLoading(!0);let t=document.getElementById("cardSelect"),r=document.getElementById("vaulted-first-name").innerText,a=document.getElementById("vaulted-last-name").innerText,i={amount:this.amount,customer_vault_id:this.vaultedId,first_name:r,last_name:a,billing_id:t.value??null};if("order_payment"===e)document.getElementById("nmiPaymentData").value=JSON.stringify(i),document.getElementById("confirmOrderForm").submit();else{let e=this.options.paymentUrls.vaulted;this.submitToPaymentService(e,i,!0)}}displayErrors(e){let t=document.getElementById("error-message"),r=t.querySelector(".error-alert");r.innerHTML="",e.length>0?(r.textContent=e.join(" "),t.classList.remove("d-none"),t.classList.add("d-block")):(t.classList.add("d-none"),t.classList.remove("d-block"))}submitToPaymentService(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2];let a=document.getElementById("orderProcessingLoader1"),i=document.getElementById("orderProcessingLoader2"),n=document.querySelector(".nmiConfirmFormSubmit1"),o=document.querySelector(".nmiConfirmFormSubmit2");n&&a?a.style.display="flex":o&&i&&(i.style.display="flex"),r.submitPayment(e,t).then(e=>{if(e.success){let t=e.responses.payment.transaction_id,r=e.responses.payment.isSubscriptionCart,a=document.getElementById("cardSelect"),i=a?a.value:null;t&&(document.getElementById("nmi-transaction-id").value=t??null,document.getElementById("nmi-is-subscription").value=r??null,document.getElementById("nmi-selected-billing-id").value=i??null),document.getElementById("confirmOrderForm").submit()}else{let t=e.errors||[e.message||"An unknown error occurred"];this.displayErrors(t),a&&(a.style.display="none"),i&&(i.style.display="none")}}).catch(e=>{this.displayErrors([e.message||"Unexpected error occurred. Please try again later."]),a&&(a.style.display="none"),i&&(i.style.display="none")})}async submitCard(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{await r.addBillingToCustomerData(e,t),window.location.reload()}catch(e){this.displayErrors(error),this._showLoading(!1)}}}class i extends window.PluginBaseClass{static #e=this.options={confirmFormId:"confirmOrderForm",paymentUrls:{ach:"/nmi-payment-ach"},collectJsUrl:"https://secure.nmi.com/token/Collect.js",paymentType:"ck",parentAchWrapperId:"nmi-ach-echeck"};init(){this._registerElements(),this._registerEvents()}_registerElements(){this.parentAchWrapper=document.getElementById(this.options.parentAchWrapperId),this.amount=this.parentAchWrapper.getAttribute("data-amount"),this.configs=JSON.parse(this.parentAchWrapper.getAttribute("data-configs")||"{}"),this.confirmOrderForm=document.forms[this.options.confirmFormId]}_registerEvents(){this.confirmOrderForm.addEventListener("submit",this._onPayButtonClick.bind(this))}async _onPayButtonClick(t){t.preventDefault(),await e.loadCollectJS(this.options.collectJsUrl,this.submitPayment.bind(this),this.options.paymentType,{theme:"bootstrap",primaryColor:"#007bff",secondaryColor:"#6c757d",buttonText:"Pay Now"}),this.confirmOrderForm.checkValidity()&&"undefined"!=typeof CollectJS&&CollectJS.startPaymentRequest()}submitPayment(e){if(!e.token){console.error("Tokenization failed:",e.error),this.displayErrors(e.error);return}this.submitNormalPayment(e)}submitNormalPayment(e){let t={token:e.token,amount:this.amount,first_name:document.querySelector('input[name="fname"]').value,last_name:document.querySelector('input[name="lname"]').value,address1:document.querySelector('input[name="address1"]').value,city:document.querySelector('input[name="city"]').value,state:document.querySelector('input[name="state"]').value,zip:document.querySelector('input[name="zip"]').value,checkname:e.check?.name||"",checkaba:e.check?.routing||"",checkaccount:e.check?.account||"",account_holder_type:e.check?.account_holder_type||"personal",account_type:e.check?.account_type||"checking"};this.submitToPaymentService(this.options.paymentUrls.ach,t)}displayErrors(e){let t=document.getElementById("error-message");if(!t)return;let r=t.querySelector(".error-alert")||t;r.innerHTML="",e&&e.length>0?(r.textContent=Array.isArray(e)?e.join(" "):e,t.classList.remove("d-none"),t.classList.add("d-block")):(t.classList.add("d-none"),t.classList.remove("d-block"))}submitToPaymentService(e,t){let a=document.getElementById("orderProcessingLoader1");document.querySelector(".nmiConfirmFormSubmit")&&a&&(a.style.display="flex"),r.submitPayment(e,t).then(e=>{if(e.success){let t=e.transaction_id;t&&(document.getElementById("nmi-transaction-id").value=t),document.getElementById("confirmOrderForm").submit()}else{let t=e.errors||[e.message||"An unknown error occurred"];this.displayErrors(t),a&&(a.style.display="none")}}).catch(e=>{console.error("Error submitting payment:",e),this.displayErrors([e.message||"Unexpected error occurred. Please try again later."]),a&&(a.style.display="none")})}}class n extends window.PluginBaseClass{init(){this.addCardButton=document.getElementById("addCardButton"),this.paymentForm=document.getElementById("paymentForm"),this.payButton=document.getElementById("payButton"),this.addCardButton&&this.addCardButton.addEventListener("click",this.toggleForm.bind(this)),this.payButton&&this.payButton.addEventListener("click",()=>{this.payButton.disabled=!0}),this.initCardActions()}toggleForm(){try{"block"===this.paymentForm.style.display?(this.paymentForm.style.display="none",this.addCardButton.textContent="+ Add Card"):(this.paymentForm.style.display="block",this.addCardButton.textContent="- Remove Card",CollectJS.configure({callback:async e=>{try{e.error?this.displayErrors(Array.isArray(e.error)?e.error:[e.error]):await this.submitPaymentData(e)}catch(e){this.displayErrors([e.message||"Unexpected error in payment callback."])}},variant:"inline",googleFont:"Abel",invalidCss:{color:"#B40E3E"},validCss:{color:"#175033"},customCss:{"border-color":"#FFFFFF","border-style":"solid"},focusCss:{"border-color":"#3e79db","border-style":"solid","border-width":"3px"},fields:{ccnumber:{selector:"#ccnumber",title:"Card Number",placeholder:"0000 0000 0000 0000"},ccexp:{selector:"#ccexp",title:"Card Expiration",placeholder:"01 / 25"},cvv:{display:"show",selector:"#cvv",title:"CVV Code",placeholder:"***"}}}))}catch(e){this.displayErrors([e.message||"Unexpected error toggling the payment form."])}}async submitPaymentData(e){try{let t=document.querySelector(".theForm"),r={first_name:t.fname.value,last_name:t.lname.value,token:e.token,ccnumber:e.card.number,ccexp:e.card.exp,card_type:e.card.type,vaulted_customer_id:document.getElementById("delete-all").getAttribute("data-vault-id")},a=await fetch("/nmi-add-card",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),i=await a.json();i.success?t.submit():this.displayErrors(i.errors||["Payment failed."])}catch(e){this.displayErrors([e.message||"Error submitting payment data."])}}initCardActions(){let e=document.querySelectorAll(".delete-card-btn"),t=document.querySelectorAll(".set-default-btn"),r=document.getElementById("delete-all");r&&r.addEventListener("click",()=>{let e=r.getAttribute("data-vault-id");this.deleteCustomerVault(e)}),e.forEach(e=>{e.addEventListener("click",()=>{let t=e.getAttribute("data-billing-id"),r=e.closest(".credit-card").getAttribute("data-vaulted-id");this.deleteVaultedCustomerData(r,t)})}),t.forEach(e=>{e.addEventListener("click",()=>{let t=e.closest(".credit-card"),r=e.getAttribute("data-billing-id"),a=t.getAttribute("data-vaulted-id");this.setCardAsDefault(a,r)})})}deleteVaultedCustomerData(e,t){fetch("/account/delete-billing-id",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({vaulted_customer_id:e,billing_id:t})}).then(e=>e.json()).then(()=>window.location.reload()).catch(e=>this.displayErrors([e.message||"Error deleting billing."]))}setCardAsDefault(e,t){fetch("/account/set-default-billing-id",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({vaulted_customer_id:e,billing_id:t})}).then(e=>e.json()).then(()=>window.location.reload()).catch(e=>this.displayErrors([e.message||"Error setting billing as default."]))}deleteCustomerVault(e){fetch("/nmi-payment-delete-vaulted-customer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customer_vault_id:e})}).then(e=>e.json()).then(()=>window.location.reload()).catch(e=>this.displayErrors([e.message||"Error deleting customer vault."]))}}let o=window.PluginManager;o.register("NmiCreditCardPlugin",a,"[nmi-payment-credit-card-plugin]"),o.register("NmiSavedCardsPlugin",n,"[data-nmi-payment-saved-cards-plugin]"),o.register("NmiAchEcheckPlugin",i,"[nmi-payment-ach-eCheck-plugin]")})();